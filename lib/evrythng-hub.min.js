!function(a,b){"use strict";if("function"==typeof define&&define.amd)define("optional",[],{load:function(a,b,c){var d=function(a){c(a)},e=function(a){var c=a.requireModules&&a.requireModules[0];requirejs.undef(c),define(c,[],function(){}),b([c],d)};b([a],d,e)}}),define(["optional!evrythng-ws","optional!jsrsasign","optional!node-jose-browserified"],function(a,c,d){return b(void 0,a,c,d)});else if("object"==typeof exports){var c,d,e,f;f=function(a){var b;try{b=require(a)}catch(c){}finally{return b}},c=f("evrythng-mqtt"),d=f("jsrsasign"),e=f("node-jose"),module.exports=b(c,void 0,d,e)}else a.EVT.Hub=a.Evrythng.Hub=b(void 0,a.EVT.WS,a.KJUR,a.nodeJose)}(this,function(a,b,c,d){"use strict";function e(a){return"[object Object]"===Object.prototype.toString.call(a)}function f(){return d.util.base64url.encode(d.util.randomBytes(32))}function g(a){return d.JWK.asKey(a)}function h(a,b,c){return c=c||{},e(a)&&(a=JSON.stringify(a)),d.JWE.createEncrypt(c,b).update(a)["final"]()}function i(a,b){return d.JWE.createDecrypt(b).decrypt(a).then(function(a){return a.plaintext.toString()})}function j(a,b){var d={alg:"HS256",typ:"JWT"},e={iss:a.iss,aud:a.aud,sub:a.sub,jti:a.jti||f(),data:a.data};return c.jws.JWS.sign("HS256",JSON.stringify(d),JSON.stringify(e),b)}function k(a,b,d){return d=d||{},d.alg=["HS256"],c.jws.JWS.verifyJWT(a,b,d)}function l(a){return a=a.split("."),{header:JSON.parse(p(a[0])),payload:JSON.parse(p(a[1]))}}function m(a,b){return h(a,b,{format:"compact"})}function n(a,b,c){var d=j({iss:c.iss,aud:c.aud,sub:c.sub,data:a},b.kid);return h(d,b)}function o(a,b,c){return i(a,b).then(function(a){var d=k(a,b.kid,{iss:[c.iss],aud:[c.aud],sub:[c.sub]});if(d)return l(a).payload.data;throw new Error("Unable to verify jsonwebtoken")})}function p(a){return d.util.base64url.decode(a,"utf8")}var q="1.2.0",r={httpApiUrl:"http://localhost:8787",mqttApiUrl:"mqtt://localhost:4001/mqtt",wsApiUrl:"ws://localhost:4000/mqtt",timeout:1e3,remote:!1,secure:!1,hubId:null},s=[{path:/^\/thngs$/,method:["get"]},{path:/^\/thngs\/[^\/]+$/,method:["get"]},{path:/^\/thngs\/[^\/]+\/properties$/,method:["post","get","put"]},{path:/^\/thngs\/[^\/]+\/properties\/[^\/]+$/,method:["get","put"]},{path:/^\/thngs\/[^\/]+\/actions\/[^\/]+$/,method:["post","get"]},{path:/^\/thngs\/[^\/]+\/actions\/[^\/]+\/[^\/]+$/,method:["get"]},{path:/^\/collections$/,method:["get"]},{path:/^\/collections\/[^\/]+$/,method:["get"]},{path:/^\/collections\/[^\/]+\/thngs$/,method:["get"]},{path:/^\/collections\/[^\/]+\/actions\/[^\/]+$/,method:["post","get"]},{path:/^\/collections\/[^\/]+\/actions\/[^\/]+\/[^\/]+$/,method:["get"]},{path:/^\/actions$/,method:["get"]}],t={version:q,settings:r,setup:function(a){function b(a){return a.secure&&!a.hubId?(console.warn("[EvrythngJS Hub] hubId option required for enabling secure mode"),a.secure=!1):!a.secure||!a.hubId||c&&d||(console.warn("[EvrythngJS Hub] jsrsasign and node-jose(-browserified) required for enabling secure mode"),a.secure=!1),a.apiUrl&&(console.warn("[EvrythngJS Hub] apiUrl option has been deprecated. Use httpApiUrl instead."),a.httpApiUrl=a.apiUrl,delete a.apiUrl),a}if(!e(a))throw new TypeError("Setup should be called with an options object.");for(var f in a)a.hasOwnProperty(f)&&(this.settings[f]=a[f]);return b(this.settings)},install:function(c,d){function f(a){var b=void 0!==a.remote?a.remote:z.settings.remote;if(b)return B.api.apply(c,arguments);for(var d=/^(.*?)(\?|$)/.exec(a.url)[1],e=a.method||"get",f=arguments,g=0;g<s.length&&(!s[g].path.test(d)||-1===s[g].method.indexOf(e));g++);return g<s.length?(a.apiUrl=z.settings.httpApiUrl,a.timeout=z.settings.timeout,z.settings.secure?(w||(w=r(a.authorization).then(function(a){x=a})),w.then(function(){return j(f)})):B.api.apply(c,f)["catch"](function(b){return A&&b&&b.cancelled?void 0:(q(a),B.api.apply(c,f))})):B.api.apply(c,f)}function i(b){return function(){if(z.settings.remote)return B[b].apply(this,arguments);var c=A.settings.apiUrl,d=A===a?z.settings.mqttApiUrl:z.settings.wsApiUrl,e=this,f=arguments;return A.setup({apiUrl:d}),z.settings.secure?(w||(w=r(e.scope.apiKey).then(function(a){x=a})),w.then(function(){var a=e.scope.apiKey;return e.scope.encryptedApiKey||(y=h(a,x,{format:"compact"}).then(function(a){e.scope.encryptedApiKey=a})),y.then(function(){return"subscribe"===b?l(e,f,c):p(e,f,c)})})):B[b].apply(e,f)["catch"](function(a){return A.setup({apiUrl:c}),B[b].apply(e,f)})}}function j(a){var b=a[0],d=a[1],e=b.authorization,f=b.data;return k(b).then(function(d){return b.authorization=d[0],b.data&&(b.data=d[1]),a[1]=void 0,B.api.apply(c,a)}).then(function(a){return a?o(a,x,{aud:e,iss:z.settings.hubId,sub:b.url}).then(function(a){return d?void d(a):a}):void 0})["catch"](function(g){return q(b),b.authorization=e,a[1]=d,b.data&&(b.data=f),B.api.apply(c,a)})}function k(a){var b=[];return b.push(m(a.authorization,x)),a.data&&b.push(n(a.data,x,{aud:z.settings.hubId,iss:a.authorization,sub:a.url})),Promise.all(b)}function l(a,b,c){var d,e=b[0],f=a.scope.apiKey;d=function(b){return o(b,x,{aud:f,iss:z.settings.hubId,sub:a.path}).then(function(b){return e(a.parse(b))})},a.scope.apiKey=a.scope.encryptedApiKey,b[0]=d;var g=B.subscribe.apply(a,b);return a.scope.apiKey=f,g["catch"](function(){return A.setup({apiUrl:c}),b[0]=e,B.subscribe.apply(a,b)})}function p(a,b,d){var e=b[0],f=c.api,g=a.scope.apiKey;c.api=v(a,g);var h=B.publish.apply(a,b);return c.api=f,h["catch"](function(){A.setup({apiUrl:d}),b[0]=e,c.api=B.api;var g=B.publish.apply(a,b);return c.api=f,g})}function q(a){delete a.apiUrl,delete a.timeout}function r(a){return t(z.settings.hubId,a).then(function(a){return u(a)?g(a.customFields.key):void 0})}function t(a,b){var c={url:"/thngs/"+a,authorization:b};return B.api(c)}function u(a){return a&&a.customFields&&e(a.customFields.key)}function v(a,b){return function(c){var d=c.interceptors[0].request,e=function(){};return n(c.data,x,{aud:z.settings.hubId,iss:b,sub:c.url}).then(function(f){c.data=f,a.scope.apiKey=a.scope.encryptedApiKey,d(c,e),a.scope.apiKey=b})}}var w,x,y,z=this,A=a||b,B={api:c.api,subscribe:d.prototype.subscribe,publish:d.prototype.publish};c.setup({geolocation:!z.settings.secure}),z.settings.secure&&(z.utils.getSecretKey=r),c.api=f,A&&(d.prototype.subscribe=i("subscribe"),d.prototype.publish=i("publish"))}};return c&&d&&(t.utils={generateId:f,initSecretKey:g,encrypt:h,decrypt:i,createJWT:j,verifyJWT:k,decodeJWT:l,encryptHeader:m,encryptPayload:n,decryptPayload:o}),t.$inject=["core","resource"],t});
//# sourceMappingURL=evrythng-hub.min.js.map