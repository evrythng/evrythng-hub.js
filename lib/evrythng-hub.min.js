!function(a,b){"use strict";if("function"==typeof define&&define.amd)define("optional",[],{load:function(a,b,c){var d=function(a){c(a)},e=function(a){var c=a.requireModules&&a.requireModules[0];requirejs.undef(c),define(c,[],function(){}),b([c],d)};b([a],d,e)}}),define(["optional!evrythng-ws","optional!jsrsasign","optional!node-jose-browserified"],function(a,c,d){return b(void 0,a,c,d)});else if("object"==typeof exports){var c,d,e,f;f=function(a){var b;try{b=require(a)}catch(a){}finally{return b}},c=f("evrythng-mqtt"),d=f("jsrsasign"),e=f("node-jose"),module.exports=b(c,void 0,d,e)}else a.EVT.Hub=a.Evrythng.Hub=b(void 0,a.EVT.WS,a.KJUR,a.nodeJose)}(this,function(a,b,c,d){"use strict";function e(a){return"[object Object]"===Object.prototype.toString.call(a)}function f(){return d.util.base64url.encode(d.util.randomBytes(32))}function g(a){return d.JWK.asKey(a)}function h(a,b,c){return c=c||{},e(a)&&(a=JSON.stringify(a)),d.JWE.createEncrypt(c,b).update(a).final()}function i(a,b){return d.JWE.createDecrypt(b).decrypt(a).then(function(a){return a.plaintext.toString()})}function j(a,b){var d={alg:"HS256",typ:"JWT"},e={iss:a.iss,aud:a.aud,sub:a.sub,jti:a.jti||f(),data:a.data};return c.jws.JWS.sign("HS256",JSON.stringify(d),JSON.stringify(e),b)}function k(a,b,d){return d=d||{},d.alg=["HS256"],c.jws.JWS.verifyJWT(a,b,d)}function l(a){return a=a.split("."),{header:JSON.parse(p(a[0])),payload:JSON.parse(p(a[1]))}}function m(a,b){return h(a,b,{format:"compact"})}function n(a,b,c){var d=j({iss:c.iss,aud:c.aud,sub:c.sub,data:a},b.kid);return h(d,b)}function o(a,b,c){return i(a,b).then(function(a){var d=k(a,b.kid,{iss:[c.iss],aud:[c.aud],sub:[c.sub]});if(d)return l(a).payload.data;throw new Error("Unable to verify jsonwebtoken")})}function p(a){return d.util.base64url.decode(a,"utf8")}var q="1.3.0",r={httpApiUrl:"http://localhost:8787",mqttApiUrl:"mqtt://localhost:4001/mqtt",wsApiUrl:"ws://localhost:4000/mqtt",timeout:1e3,remote:!1,secure:{request:!0,response:!1},hubId:null},s=[{path:/^\/thngs$/,method:["get"]},{path:/^\/thngs\/[^\/]+$/,method:["get"]},{path:/^\/thngs\/[^\/]+\/properties$/,method:["post","get","put"]},{path:/^\/thngs\/[^\/]+\/properties\/[^\/]+$/,method:["get","put"]},{path:/^\/thngs\/[^\/]+\/actions\/[^\/]+$/,method:["post","get"]},{path:/^\/thngs\/[^\/]+\/actions\/[^\/]+\/[^\/]+$/,method:["get"]},{path:/^\/collections$/,method:["get"]},{path:/^\/collections\/[^\/]+$/,method:["get"]},{path:/^\/collections\/[^\/]+\/thngs$/,method:["get"]},{path:/^\/collections\/[^\/]+\/actions\/[^\/]+$/,method:["post","get"]},{path:/^\/collections\/[^\/]+\/actions\/[^\/]+\/[^\/]+$/,method:["get"]},{path:/^\/actions$/,method:["get"]}],t={version:q,settings:r,setup:function(a){function b(a){return a.secure&&!a.hubId?(console.warn("[EvrythngJS Hub] hubId option required for enabling secure mode"),a.secure=!1):!a.secure||!a.hubId||c&&d||(console.warn("[EvrythngJS Hub] jsrsasign and node-jose(-browserified) required for enabling secure mode"),a.secure=!1),a}if(!e(a))throw new TypeError("Setup should be called with an options object.");for(var f in a)a.hasOwnProperty(f)&&(this.settings[f]=a[f]);return b(this.settings)},install:function(c,d){function f(a){var b=arguments,d=[{request:i},{request:j},{request:k},{request:l}];return a.interceptors=d.concat(a.interceptors||[]).concat(c.settings.interceptors||[]),H.api.apply(c,b).catch(function(d){if(!(C&&d&&d.cancelled))return console.info("[EvrythngJS Hub] Local endpoint failed: ",d),console.info("[EvrythngJS Hub] Switching to remote endpoint..."),delete a.apiUrl,delete a.timeout,a.interceptors=[],H.api.apply(c,b)})}function h(b){return function(){if(B.settings.remote)return H[b].apply(this,arguments);var c,d,e=C.settings.apiUrl,f=C===a?B.settings.mqttApiUrl:B.settings.wsApiUrl,g=this,h=arguments,i=h[0];c=w(g.scope.apiKey)?F[g.scope.apiKey]:g.scope.apiKey;var m=[{request:j},{request:k},{request:l},{request:function(a,b){d=a.headers.authorization,b()}}];return H.api({authorization:g.scope.apiKey,remote:!1,secure:B.settings.secure,interceptors:m}).catch(function(){return g.scope.apiKey=d,C.setup({apiUrl:f}),u(B.settings)&&"subscribe"===b&&(h[0]=A(h[0],{url:g.path,authorization:c})),H[b].apply(g,h).catch(function(a){return C.setup({apiUrl:e}),u(B.settings)&&"subscribe"===b&&(h[0]=i),g.scope.apiKey=c,console.info("[EvrythngJS Hub] Local endpoint failed: ",a),console.info("[EvrythngJS Hub] Switching to remote endpoint..."),H[b].apply(g,h)})})}}function i(a){return q(a)?a:(y(a)&&(a.apiUrl=B.settings.httpApiUrl,a.timeout=B.settings.timeout),a)}function j(a){return!v(a)||q(a)?a:(D||(D=H.api({url:"/thngs/"+B.settings.hubId,interceptors:[],authorization:a.authorization})),a)}function k(a){return D?D.then(function(b){return z(b)&&(E=g(b.customFields.key)),a}):a}function l(a){return E?E.then(function(b){var c=[],d={};return w(a.authorization)?(c.push(Promise.resolve(a.authorization)),a.authorization=F[a.authorization]):c.push(x(a.authorization,b)),d.authorization=a.authorization,d.url=a.url,a.data&&c.push(n(a.data,b,{iss:a.authorization,aud:B.settings.hubId,sub:a.url})),Promise.all(c).then(function(b){return a.headers.authorization=b[0],F[a.authorization]||(F[b[0]]=a.authorization),a.data&&(a.data=b[1]),u(a)&&(a.interceptors=[{response:function(a){return p(a,d)}}]),a})}):a}function p(a,b){if(a)return E.then(function(c){return o(a,c,{aud:b.authorization,iss:B.settings.hubId,sub:b.url}).then(function(a){return a})})}function q(a){return void 0!==a.remote?a.remote:B.settings.remote}function r(a){return void 0!==a.secure?a.secure:B.settings.secure}function t(a){var b=r(a);return b===!0||b.request}function u(a){var b=r(a);return b===!0||b.response}function v(a){return t(a)||u(a)}function w(a){return a.indexOf(".")>-1}function x(a,b){if(G[a])return G[a];var c=m(a,b);return G[a]=c,c}function y(a){for(var b=/^(.*?)(\?|$)/.exec(a.url)[1],c=a.method||"get",d=0;d<s.length&&(!s[d].path.test(b)||s[d].method.indexOf(c)===-1);d++);return d<s.length}function z(a){return a&&a.customFields&&e(a.customFields.key)}function A(a,b){return function(c){var d=c.resource;return E.then(function(e){return o(c,e,{aud:b.authorization,iss:B.settings.hubId,sub:b.url}).then(function(b){return a(d.parse(b))})})}}var B=this,C=a||b,D=null,E=null,F={},G={},H={api:c.api,subscribe:d.prototype.subscribe,publish:d.prototype.publish};c.api=f,C&&(d.prototype.subscribe=h("subscribe"),d.prototype.publish=h("publish"))}};return c&&d&&(t.utils={generateId:f,initSecretKey:g,encrypt:h,decrypt:i,createJWT:j,verifyJWT:k,decodeJWT:l,encryptHeader:m,encryptPayload:n,decryptPayload:o}),t.$inject=["core","resource"],t});
//# sourceMappingURL=evrythng-hub.min.js.map